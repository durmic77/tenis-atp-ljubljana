<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenis ATP Ljubljana - Skupna Lestvica</title>
    <!-- Nalaganje Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

<!-- FAVICON & APP ICONS -->
<!-- Osnovni favicon -->
    <link rel="icon" type="image/png" href="sponsors/tenisLJ.png">

<!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="sponsors/tenisLJ.png">

<!-- PWA Manifest (za browser shortcuts) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f59e0b">

    
    <!-- Firebase SDK - BREZ AUTHENTICATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAxnOW1kSRD1KOqtKFj1CojlPWiCeLf4hI",
            authDomain: "atp-list.firebaseapp.com",
            projectId: "atp-list",
            storageBucket: "atp-list.firebasestorage.app",
            messagingSenderId: "76413250525",
            appId: "1:76413250525:web:167a48fc2826df2275a434",
            measurementId: "G-G9Z3Q4Z8KV"
        };
        
        // Inicializacija BREZ AUTH
        try {
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            
            console.log("‚úÖ Povezava z bazo uspe≈°na!");
            
            // Takoj za≈æeni poslu≈°alce
            if (window.startFirestoreListeners) {
                window.startFirestoreListeners();
            }
            
        } catch (e) {
            console.error("‚ùå Napaka pri povezavi:", e);
        }
        
        window.getFirestoreCollectionPaths = () => ({
            players: collection(window.db, 'tenis_players'),
            matches: collection(window.db, 'tenis_matches'),
        });

        window.ELO_CONSTANTS = {
            INITIAL_RATING: 1000,
            K_FACTOR: 40
        };

        window.dbRef = {
            doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot
        };
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            color: #f3f4f6;
        }
        .table-header {
            background-color: #374151;
            color: #d1d5db;
        }
        .table-row-even {
            background-color: #1f2937;
        }
        .table-row-odd {
            background-color: #111827;
        }
        .sponsor-image {
            max-height: 80px;
            width: auto;
        }
        .match-row-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .status-hidden {
            display: none;
        }

        /* MOBILE OPTIMIZACIJA */
        @media (max-width: 768px) {
            /* Tabela - brez horizontalnega scrolla */
            #rankingTable {
                font-size: 0.75rem;
            }
            #rankingTable td, #rankingTable th {
                padding: 10px 4px;
                white-space: nowrap;
            }
            #rankingTable th:nth-child(4), 
            #rankingTable td:nth-child(4),
            #rankingTable th:nth-child(5),
            #rankingTable td:nth-child(5) {
                display: none;
            }

            /* Input polja za rezultate - VEƒåJA */
            input[type="number"] {
                min-height: 44px !important;
                font-size: 18px !important;
                padding: 10px 6px !important;
                background: #4b5563 !important;
                border: 2px solid #6b7280 !important;
                color: white !important;
                width: 100% !important;
            }
            
            /* Placeholder text bolj viden */
            input::placeholder {
                color: #d1d5db !important;
                font-size: 14px;
                opacity: 0.8;
            }

            /* Set inputs v en stolpec na mobile */
            .grid-cols-3 {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
            
            /* Vsak set dobi veƒç prostora */
            .grid-cols-3 > div {
                padding: 14px;
                background: #374151;
                border-radius: 10px;
                margin-bottom: 8px;
            }

            /* Bolj≈°i spacing za mobile */
            .bg-gray-800 {
                padding: 1rem !important;
            }

            /* Manj≈°i padding za mobile */
            body {
                padding: 0.5rem !important;
            }
        }

        /* Desktop ostane popolnoma enak */
        @media (min-width: 769px) {
            /* Vse ostane kot je */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#f59e0b',
                        'secondary': '#10b981',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-primary mb-6 text-center">Tenis ATP Ljubljana - Skupna Lestvica</h1>
        
        <!-- Skrit status (samo za debugging) -->
        <div id="authStatus" class="status-hidden"></div>

        <!-- Prikaz sporoƒçil -->
        <div id="messageBox" class="p-3 mb-4 rounded-lg hidden text-center font-medium"></div>

        <!-- 1. Lestvica Igralcev -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Aktivna Lestvica</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header uppercase text-left">
                            <th class="py-3 px-4 rounded-tl-lg">Mesto</th>
                            <th class="py-3 px-4">Igralec</th>
                            <th class="py-3 px-4">Toƒçke (ELO)</th>
                            <th class="py-3 px-4 hidden md:table-cell">Zmage</th>
                            <th class="py-3 px-4 rounded-tr-lg hidden md:table-cell">Porazi</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTable">
                        <tr><td colspan="5" class="text-center py-4 text-gray-400">Nalaganje podatkov...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 2. Zabele≈æi Tekmo -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Zabele≈æi Novo Tekmo</h2>

            <!-- Igralca (v dveh stolpcih) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="winnerSelect" class="block text-sm font-medium mb-1 text-gray-300">Zmagovalec:</label>
                    <select id="winnerSelect" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-secondary transition">
                        <option value="0">Izberi zmagovalca...</option>
                    </select>
                </div>
                <div>
                    <label for="loserSelect" class="block text-sm font-medium mb-1 text-gray-300">Pora≈æenec:</label>
                    <select id="loserSelect" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-secondary transition">
                        <option value="0">Izberi pora≈æenca...</option>
                    </select>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-gray-300 border-b border-gray-700 pb-1">Podrobnosti in Tip Tekme</h3>
            
            <!-- Vrsta tekme -->
            <div class="mb-4">
                <label for="matchTypeSelect" class="block text-sm font-medium mb-1 text-gray-300">Vrsta Tekme:</label>
                <select id="matchTypeSelect" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <option value="regular">Celotna Tekma (100% ELO)</option>
                    <option value="short">Kratka Igra (50% ELO, npr. 4-3, 4-1)</option>
                    <option value="draw">Neodloƒçeno (1-1 v setih, 0% ELO)</option>
                </select>
            </div>

            <!-- Rezultat po setih -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2 text-gray-300">Rezultat po Setih (Zmaga-Poraz):</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Set 1 -->
                    <div class="flex items-center space-x-2 bg-gray-700 p-2 rounded-lg">
                        <span class="text-gray-400 font-medium">Set 1:</span>
                        <input type="number" id="set1WinnerScore" placeholder="Zmag" class="w-1/2 p-2 bg-gray-600 rounded-md text-white placeholder-gray-400 text-center" min="0" max="7">
                        <span class="text-gray-400">-</span>
                        <input type="number" id="set1LoserScore" placeholder="Por" class="w-1/2 p-2 bg-gray-600 rounded-md text-white placeholder-gray-400 text-center" min="0" max="7">
                    </div>
                    <!-- Set 2 -->
                    <div class="flex items-center space-x-2 bg-gray-700 p-2 rounded-lg">
                        <span class="text-gray-400 font-medium">Set 2:</span>
                        <input type="number" id="set2WinnerScore" placeholder="Zmag" class="w-1/2 p-2 bg-gray-600 rounded-md text-white placeholder-gray-400 text-center" min="0" max="7">
                        <span class="text-gray-400">-</span>
                        <input type="number" id="set2LoserScore" placeholder="Por" class="w-1/2 p-2 bg-gray-600 rounded-md text-white placeholder-gray-400 text-center" min="0" max="7">
                    </div>
                    <!-- Set 3 (Opcijsko) -->
                    <div class="flex items-center space-x-2 bg-gray-700 p-2 rounded-lg">
                        <span class="text-gray-400 font-medium">Set 3:</span>
                        <input type="number" id="set3WinnerScore" placeholder="Zmag" class="w-1/2 p-2 bg-gray-600 rounded-md text-white placeholder-gray-400 text-center" min="0" max="7">
                        <span class="text-gray-400">-</span>
                        <input type="number" id="set3LoserScore" placeholder="Por" class="w-1/2 p-2 bg-gray-600 rounded-md text-white placeholder-gray-400 text-center" min="0" max="7">
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Vnesite samo ≈°tevilke. Pustite prazno, ƒçe se set ni igral.</p>
            </div>

            <!-- Datum in Podlaga (v dveh stolpcih) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="matchDateInput" class="block text-sm font-medium mb-1 text-gray-300">Datum:</label>
                    <input type="date" id="matchDateInput" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary transition">
                </div>
                <div>
                    <label for="surfaceSelect" class="block text-sm font-medium mb-1 text-gray-300">Podlaga:</label>
                    <select id="surfaceSelect" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary transition">
                        <option value="Pesek">Pesek (Clay)</option>
                        <option value="Trda">Trda (Hard)</option>
                        <option value="Trava">Trava (Grass)</option>
                        <option value="Dvorana">Dvorana (Indoor)</option>
                        <option value="Drugo">Drugo</option>
                    </select>
                </div>
            </div>

            <button onclick="recordMatch()" class="w-full bg-secondary hover:bg-emerald-600 text-gray-900 font-bold py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg">
                Posodobi Lestvico in Zabele≈æi
            </button>
        </div>

        <!-- 3. Zgodovina Tekem -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8" id="matchHistoryContainer">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Zgodovina Tekem</h2>
            <div class="text-center py-4 text-gray-400">Nalaganje zgodovine...</div>
        </div>
        
        <!-- 4. Dodaj Igralca -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
            <button onclick="toggleAddPlayerForm()" id="togglePlayerBtn" class="w-full bg-primary hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg flex items-center justify-center">
                <span id="togglePlayerText">Dodaj Novega Igralca</span>
            </button>
            
            <div id="addPlayerForm" class="mt-4 hidden border border-primary/50 p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-3 text-primary">Vnos novega igralca</h3>
                <input type="text" id="newPlayerName" placeholder="Ime igralca..." class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary transition">
                <button onclick="addPlayer()" class="w-full mt-3 bg-secondary hover:bg-emerald-600 text-gray-900 font-bold py-2 rounded-lg transition shadow-md">
                    Potrdi Dodajanje Igralca
                </button>
            </div>
        </div>

        <!-- 5. SPONZORJI -->
        <div class="mt-8 pt-4 border-t border-gray-700 text-center">
            <h3 class="text-lg font-medium text-gray-400 mb-4">Sponzorirano s strani:</h3>
            <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-8">
                <!-- Sponzor 1 -->
                <img src="sponsors/kolektor-etra-2.png" alt="Sponzor 1" class="sponsor-image filter drop-shadow-lg" onerror="this.onerror=null; this.src='https://placehold.co/300x80/1f2937/d1d5db?text=Sponzor+logo+1';" />
                <!-- Sponzor 2 -->
                <img src="sponsors/Union-Radler-00.png" alt="Sponzor 2" class="sponsor-image filter drop-shadow-lg" onerror="this.onerror=null; this.src='https://placehold.co/300x80/1f2937/d1d5db?text=Sponzor+logo+2';" />
		<!-- Sponzor 3 -->
                <img src="sponsors/Marlboro.png" alt="Sponzor 2" class="sponsor-image filter drop-shadow-lg" onerror="this.onerror=null; this.src='https://placehold.co/300x80/1f2937/d1d5db?text=Sponzor+logo+3';" />
            </div>
        </div>

    </div>

    <!-- GLAVNA JS LOGIKA -->
    <script type="module">
        const { doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot } = window.dbRef || {};
        const { INITIAL_RATING, K_FACTOR } = window.ELO_CONSTANTS || {};
        
        let playersData = []; 
        let matchesData = []; 
        let filteredPlayerId = null; 
        let showAllHistory = false; 

        function showMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'p-3 mb-4 rounded-lg text-center font-medium';
            if (type === 'success') {
                box.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                box.classList.add('bg-red-600', 'text-white');
            } else {
                box.classList.add('bg-blue-600', 'text-white');
            }
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        function toggleAddPlayerForm() {
            const form = document.getElementById('addPlayerForm');
            const buttonText = document.getElementById('togglePlayerText');
            const isHidden = form.classList.toggle('hidden');
            
            if (isHidden) {
                buttonText.textContent = 'Dodaj Novega Igralca';
            } else {
                buttonText.textContent = 'Skrij Vnos Igralca';
            }
        }
        
        function setDefaultDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); 
            const dd = String(today.getDate()).padStart(2, '0');
            const dateInput = document.getElementById('matchDateInput');
            if (dateInput) dateInput.value = `${yyyy}-${mm}-${dd}`;
        }
        
        // ELO PRERAƒåUN
        function calculateEloFromMatches(currentPlayers, currentMatches) {
            const playerMap = new Map(currentPlayers.map(p => ([
                p.id, 
                { id: p.id, name: p.name, rating: INITIAL_RATING, wins: 0, losses: 0 }
            ])));

            const matches = [...currentMatches].sort((a, b) => a.id - b.id);

            matches.forEach(match => {
                const winner = playerMap.get(match.winnerId);
                const loser = playerMap.get(match.loserId);
                
                if (!winner || !loser) return;
                
                let currentKFactor = match.type === 'short' ? K_FACTOR / 2 : K_FACTOR;
                let finalRatingChange = 0;
                
                if (match.type !== 'draw') {
                    const expectedScoreA = 1 / (1 + Math.pow(10, (loser.rating - winner.rating) / 400));
                    const ratingChange = currentKFactor * (1 - expectedScoreA);
                    finalRatingChange = Math.round(ratingChange);

                    winner.rating = Math.round(winner.rating + ratingChange);
                    loser.rating = Math.round(loser.rating - ratingChange);

                    winner.wins += 1;
                    loser.losses += 1;
                }
                
                match.winnerNewRating = winner.rating;
                match.loserNewRating = loser.rating;
                match.winnerEloChange = finalRatingChange;
                match.loserEloChange = -finalRatingChange;
            });
            
            return playerMap;
        }

        async function recalculateEloAndSave() {
            const updatedPlayerMap = calculateEloFromMatches(playersData, matchesData);
            const playersRef = window.getFirestoreCollectionPaths().players;
            
            const playerUpdates = [];
            updatedPlayerMap.forEach((updatedPlayer, id) => {
                const existingPlayer = playersData.find(p => p.id === id);
                if (existingPlayer) {
                    playerUpdates.push({
                        docRef: doc(playersRef, id),
                        data: {
                            name: existingPlayer.name,
                            rating: updatedPlayer.rating,
                            wins: updatedPlayer.wins,
                            losses: updatedPlayer.losses,
                            id: updatedPlayer.id
                        }
                    });
                }
            });

            await Promise.all(playerUpdates.map(async (update) => {
                try {
                    await setDoc(update.docRef, update.data);
                } catch (e) {
                    console.error(`Napaka pri posodabljanju igralca ${update.data.name}:`, e);
                }
            }));
        }

        // FIREBASE OPERACIJE
        async function addPlayer() {
            const input = document.getElementById('newPlayerName');
            const name = input.value.trim();

            if (!name) {
                showMessage('Vnesite ime igralca.', 'error');
                return;
            }

            if (playersData.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showMessage(`Igralec "${name}" ≈æe obstaja.`, 'error');
                return;
            }

            const playersRef = window.getFirestoreCollectionPaths().players;
            
            try {
                const docRef = await addDoc(playersRef, {
                    name: name,
                    rating: INITIAL_RATING,
                    wins: 0,
                    losses: 0
                });
                
                await updateDoc(doc(playersRef, docRef.id), { id: docRef.id });

                input.value = '';
                toggleAddPlayerForm();
                showMessage(`Igralec "${name}" je bil dodan!`, 'success');
            } catch (e) {
                console.error("Napaka pri dodajanju igralca:", e);
                showMessage('Napaka pri dodajanju igralca', 'error');
            }
        }

        async function recordMatch() {
            const winnerId = document.getElementById('winnerSelect').value;
            const loserId = document.getElementById('loserSelect').value;
            const dateInput = document.getElementById('matchDateInput').value;
            const surface = document.getElementById('surfaceSelect').value;
            const matchType = document.getElementById('matchTypeSelect').value;

            const scoreInputs = [
                { w: document.getElementById('set1WinnerScore').value, l: document.getElementById('set1LoserScore').value },
                { w: document.getElementById('set2WinnerScore').value, l: document.getElementById('set2LoserScore').value },
                { w: document.getElementById('set3WinnerScore').value, l: document.getElementById('set3LoserScore').value },
            ];
            
            let scores = [];
            scoreInputs.forEach(s => {
                if (s.w.trim() !== '' && s.l.trim() !== '') {
                    scores.push(`${s.w.trim()}-${s.l.trim()}`);
                }
            });
            const scoreString = scores.join(', ');

            if (winnerId === '0' || loserId === '0' || winnerId === loserId) {
                showMessage('Izberite veljavnega zmagovalca in pora≈æenca.', 'error');
                return;
            }
            if (scoreString === '' && matchType !== 'draw') {
                 showMessage('Vnesite rezultat vsaj prvega seta (ali izberite Neodloƒçeno).', 'error');
                 return;
            }

            const winner = playersData.find(p => p.id === winnerId);
            const loser = playersData.find(p => p.id === loserId);

            if (!winner || !loser) {
                showMessage('Igralec ni najden v spominu. Osve≈æite stran.', 'error');
                return;
            }
            
            const timestamp = Date.now();
            let dateString;
            
            if (dateInput) {
                const d = new Date(dateInput + 'T12:00:00'); 
                dateString = d.toLocaleDateString('sl-SI', { year: 'numeric', month: '2-digit', day: '2-digit' });
            } else {
                dateString = new Date().toLocaleDateString('sl-SI') + ' ' + new Date().toLocaleTimeString('sl-SI', { hour: '2-digit', minute: '2-digit' });
            }
            
            const newMatch = {
                id: timestamp,
                date: dateString,
                winnerId: winnerId,
                loserId: loserId,
                winnerName: winner.name,
                loserName: loser.name,
                score: matchType === 'draw' ? '1-1 v setih' : scoreString,
                surface: surface,
                type: matchType,
            };

            try {
                const matchesRef = window.getFirestoreCollectionPaths().matches;
                await addDoc(matchesRef, newMatch);

                // Poƒçisti polja
                document.getElementById('set1WinnerScore').value = '';
                document.getElementById('set1LoserScore').value = '';
                document.getElementById('set2WinnerScore').value = '';
                document.getElementById('set2LoserScore').value = '';
                document.getElementById('set3WinnerScore').value = '';
                document.getElementById('set3LoserScore').value = '';
                
                document.getElementById('winnerSelect').value = '0';
                document.getElementById('loserSelect').value = '0';

                showMessage(`Tekma zabele≈æena! Lestvica se posodablja.`, 'success');

            } catch (e) {
                console.error("Napaka pri zapisovanju tekme:", e);
                showMessage('Napaka pri bele≈æenju tekme', 'error');
            }
        }

        async function deleteMatch(docId) {
            try {
                const matchesRef = window.getFirestoreCollectionPaths().matches;
                await deleteDoc(doc(matchesRef, docId));
                showMessage('Tekma uspe≈°no izbrisana', 'success');
            } catch (e) {
                console.error("Napaka pri brisanju tekme:", e);
                showMessage('Napaka pri brisanju tekme', 'error');
            }
        }

        // RENDER FUNKCIJE
        function getSortedPlayers() {
            return [...playersData].sort((a, b) => b.rating - a.rating);
        }

        function renderRanking() {
            const tableBody = document.getElementById('rankingTable');
            const players = getSortedPlayers();
            tableBody.innerHTML = '';

            if (players.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">Trenutno ni registriranih igralcev. Dodajte prvega igralca.</td></tr>`;
                return;
            }

            const totalPlayers = players.length;

            players.forEach((player, index) => {
                const rank = index + 1;
                let playerName = player.name;
                
                // Ikone za Goat in Potato :)
                if (rank === 1 && totalPlayers > 0) {
                    playerName = `üêê ${playerName}`;
                } else if (rank === totalPlayers && totalPlayers > 1) {
                    playerName = `ü•î ${playerName}`;
                }

                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'table-row-even' : 'table-row-odd';

                row.innerHTML = `
                    <td class="py-3 px-4 font-bold text-lg text-primary">${rank}.</td>
                    <td class="py-3 px-4 font-medium cursor-pointer hover:text-primary transition" onclick="window.filterHistoryByPlayer('${player.id}')">${playerName}</td>
                    <td class="py-3 px-4 font-semibold text-secondary">${player.rating}</td>
                    <td class="py-3 px-4 text-emerald-400 hidden md:table-cell">${player.wins}</td>
                    <td class="py-3 px-4 text-red-400 hidden md:table-cell">${player.losses}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderMatchHistory() {
            const containerDiv = document.getElementById('matchHistoryContainer');
            
            const currentPlayers = JSON.parse(JSON.stringify(playersData));
            const calculatedMatches = JSON.parse(JSON.stringify(matchesData));
            calculateEloFromMatches(currentPlayers, calculatedMatches);

            const allMatches = calculatedMatches.sort((a, b) => b.id - a.id);
            let filteredMatches = allMatches;
            let playerName = '';

            if (filteredPlayerId) {
                const player = playersData.find(p => p.id === filteredPlayerId);
                if (player) {
                    filteredMatches = allMatches.filter(m => m.winnerId === filteredPlayerId || m.loserId === filteredPlayerId);
                    playerName = player.name;
                } else {
                    filteredPlayerId = null;
                    showAllHistory = false;
                    renderAll();
                    return;
                }
            }
            
            const totalMatches = filteredMatches.length;
            const matchesToDisplayCount = showAllHistory ? totalMatches : Math.min(totalMatches, 10);
            const matchesToDisplay = filteredMatches.slice(0, matchesToDisplayCount);
            
            let htmlContent = '';

            const titleText = filteredPlayerId 
                ? `Zgodovina Tekem (${playerName})` 
                : (showAllHistory ? 'Zgodovina Tekem (Vse)' : 'Zgodovina Tekem (Zadnjih 10)');

            htmlContent += `<h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">${titleText}</h2>`;
            
            htmlContent += `<div id="historyControls" class="mb-4 space-y-2">`;
            
            if (filteredPlayerId) {
                htmlContent += `
                    <div class="bg-blue-900/50 p-3 rounded-lg flex justify-between items-center text-sm text-gray-100">
                        <span class="font-medium">Prikazane so samo tekme za igralca: ${playerName}</span>
                        <button onclick="window.clearPlayerFilter()" class="text-red-400 hover:text-red-300 font-medium transition flex items-center space-x-1">
                            <span>Poƒçisti filter</span>
                        </button>
                    </div>
                `;
            }

            if (totalMatches > 10 && !filteredPlayerId) {
                htmlContent += `
                    <button onclick="window.toggleHistoryView()" class="w-full text-center py-2 rounded-lg ${showAllHistory ? 'bg-gray-600 hover:bg-gray-500' : 'bg-primary/20 hover:bg-primary/30'} text-white font-medium transition">
                        ${showAllHistory ? 'Prika≈æi le zadnjih 10 tekem' : `Prika≈æi vseh ${totalMatches} tekem`}
                    </button>
                `;
            }
            htmlContent += `</div>`;
            
            htmlContent += `<div id="matchListDiv" class="space-y-3">`;

            if (totalMatches === 0) {
                htmlContent += `<p class="text-center py-4 text-gray-400">Trenutno ni zgodovine tekem ${filteredPlayerId ? 'za tega igralca' : ''}.</p>`;
            } else {
                
                const formatEloChange = (change) => {
                    const changeNum = Math.round(change);
                    if (changeNum > 0) return `(+${changeNum})`;
                    if (changeNum < 0) return `(${changeNum})`;
                    return `(0)`;
                };
                
                matchesToDisplay.forEach(match => {
                    let resultText;
                    let eloDetail;
                    let scoreDisplay = match.score || 'Rezultat ni vpisan';

                    const docId = match.docId;
                    
                    if (match.type === 'draw') {
                        resultText = `<span class="font-bold text-gray-300">${match.winnerName}</span> in <span class="font-bold text-gray-300">${match.loserName}</span> sta igrala neodloƒçeno`;
                        eloDetail = `<span class="text-gray-400 font-medium">Oba igralca:</span> ${match.winnerNewRating} (ELO ostaja nespremenjen)`;
                    } else {
                        const eloChangeA = formatEloChange(match.winnerEloChange);
                        const eloChangeB = formatEloChange(match.loserEloChange);
                        
                        const eloColorA = match.type === 'short' ? 'text-primary' : 'text-secondary';
                        const eloColorB = 'text-red-400';
                        
                        resultText = `<span class="font-bold ${eloColorA}">${match.winnerName}</span> je premagal <span class="font-bold ${eloColorB}">${match.loserName}</span>`;
                        
                        eloDetail = `
                            <span class="${eloColorA} font-medium">Zmagovalec:</span> ${match.winnerNewRating} ${eloChangeA}<br>
                            <span class="${eloColorB} font-medium">Pora≈æenec:</span> ${match.loserNewRating} ${eloChangeB}
                        `;
                    }
                    
                    let typeBadgeClass = match.type === 'short' ? 'bg-yellow-800' : 
                                         match.type === 'draw' ? 'bg-blue-800' : 'bg-emerald-800';
                    
                    htmlContent += `
                        <div class="p-4 bg-gray-700 rounded-lg shadow-inner">
                            <div class="flex justify-between items-center text-sm text-gray-400 mb-2 border-b border-gray-600 pb-1">
                                <span>${match.date}</span>
                                <div class="flex items-center space-x-3">
                                    <span class="font-medium text-primary">Podlaga: ${match.surface || 'Neznano'}</span>
                                    <button onclick="window.deleteMatch('${docId}')" class="text-red-500 hover:text-red-400 transition" aria-label="Izbri≈°i tekmo">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            <p class="text-base flex justify-between items-center">
                                ${resultText}
                                <span class="text-sm font-semibold text-gray-300 ml-2">(${scoreDisplay})</span>
                            </p>
                            <div class="match-row-content mt-1">
                                <p class="text-sm">
                                    ${eloDetail}
                                </p>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${typeBadgeClass} text-white/90">
                                    ${match.type === 'short' ? 'Kratka' : match.type === 'draw' ? 'Neodloƒçeno' : 'Regularna'}
                                </span>
                            </div>
                        </div>
                    `;
                });
            }

            htmlContent += `</div>`;
            
            if (!showAllHistory && totalMatches > 10 && !filteredPlayerId) {
                 htmlContent += `<p class="text-center mt-4 text-sm text-gray-500">Prikazanih je zadnjih 10 tekem. Kliknite gumb zgoraj za prikaz vseh.</p>`;
            }
            
            containerDiv.innerHTML = htmlContent;
        }

        function renderSelects() {
            const winnerSelect = document.getElementById('winnerSelect');
            const loserSelect = document.getElementById('loserSelect');
            const players = getSortedPlayers();

            winnerSelect.innerHTML = '<option value="0">Izberi zmagovalca...</option>';
            loserSelect.innerHTML = '<option value="0">Izberi pora≈æenca...</option>';

            players.forEach(player => {
                const optionWinner = document.createElement('option');
                optionWinner.value = player.id;
                optionWinner.textContent = player.name;
                winnerSelect.appendChild(optionWinner);

                const optionLoser = document.createElement('option');
                optionLoser.value = player.id;
                optionLoser.textContent = player.name;
                loserSelect.appendChild(optionLoser);
            });
        }

        function renderAll() {
            renderRanking();
            renderSelects();
            renderMatchHistory();
        }

        // FIREBASE POSLU≈†ALCI - POPRAVLJENO
        window.startFirestoreListeners = function() {
            console.log("üöÄ Zaganjam Firebase poslu≈°alce...");
            
            const { players: playersRef, matches: matchesRef } = window.getFirestoreCollectionPaths();
            
            // Poslu≈°alec za igralce
            onSnapshot(playersRef, (snapshot) => {
                console.log("üì• Podatki igralcev posodobljeni:", snapshot.docs.length);
                playersData = snapshot.docs.map(doc => ({
                    ...doc.data(),
                    docId: doc.id,
                }));
                renderAll();
            }, (error) => {
                console.error("‚ùå Napaka pri nalaganju igralcev:", error);
            });

            // Poslu≈°alec za tekme
            onSnapshot(matchesRef, (snapshot) => {
                console.log("üì• Podatki tekem posodobljeni:", snapshot.docs.length);
                matchesData = snapshot.docs.map(doc => ({
                    ...doc.data(),
                    docId: doc.id,
                }));
                renderAll();
                recalculateEloAndSave();
            }, (error) => {
                console.error("‚ùå Napaka pri nalaganju tekem:", error);
            });
        };

        // GLOBALNE FUNKCIJE
        window.filterHistoryByPlayer = (playerId) => {
            filteredPlayerId = playerId;
            showAllHistory = true;
            renderAll();
        };

        window.clearPlayerFilter = () => {
            filteredPlayerId = null;
            showAllHistory = false;
            renderAll();
        };

        window.toggleHistoryView = () => {
            showAllHistory = !showAllHistory;
            renderMatchHistory();
        };

        window.deleteMatch = deleteMatch;
        window.recordMatch = recordMatch;
        window.addPlayer = addPlayer;
        window.toggleAddPlayerForm = toggleAddPlayerForm;

        // ZAGON
        window.onload = () => {
            setDefaultDate();
            // ƒåe se Firebase inicializacija zakljuƒçi preden je ta skripta nalo≈æena
            if (window.db && !playersData.length) {
                window.startFirestoreListeners();
            }
        };

        // Samodejni zagon ƒçe je Firebase ≈æe pripravljen
        if (window.db) {
            setTimeout(() => {
                window.startFirestoreListeners();
            }, 1000);
        }
    </script>
</body>
</html>
